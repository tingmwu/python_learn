<!DOCTYPE html>
<html>
<head>
<title>seafile.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="ubuntu%E9%83%A8%E7%BD%B2seafile%E6%9C%8D%E5%8A%A1%E7%AB%AF">ubuntu部署seafile服务端</h1>
<h2 id="1-%E5%AE%89%E8%A3%85docker">1. 安装docker</h2>
<p><a href="https://docs.docker.com/engine/install/ubuntu/">官方文档</a><br>
<em>分为 apt 安装和 dpkg 本地安装两种方式</em>（<strong>推荐本地安装</strong>）</p>
<h3 id="install-using-the-repository"><em>Install using the repository</em></h3>
<pre class="hljs"><code><div>sudo apt-get update
sudo apt-get install \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg-agent \
    software-properties-common

curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

sudo apt-key fingerprint 0EBFCD88

sudo add-apt-repository \
   <span class="hljs-string">"deb [arch=amd64] https://download.docker.com/linux/ubuntu \
   <span class="hljs-variable">$(lsb_release -cs)</span> \
   stable"</span>

<span class="hljs-comment"># 安装最新版本</span>
sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io

<span class="hljs-comment"># 查看可安装的docker版本</span>
apt-cache madison docker-ce <span class="hljs-comment"># </span>

<span class="hljs-comment"># 安装特定版本</span>
sudo apt-get install docker-ce=&lt;VERSION_STRING&gt; docker-ce-cli=&lt;VERSION_STRING&gt; containerd.io

</div></code></pre>
<h3 id="install-from-a-package"><em>Install from a package</em></h3>
<p><strong>一般apt安装docker-ce的下载过程会很慢，可以去</strong><a href="https://download.docker.com/linux/ubuntu/dists/">https://download.docker.com/linux/ubuntu/dists/</a><strong>下载之后安装</strong></p>
<ul>
<li>
<blockquote>
<p>cat /etc/*release* # 查看系统版本</br></p>
</blockquote>
</li>
<li>进入网站之后选择对应的系统版本文件夹，进入pool/stable/，选择amd64, armhf, or arm64之后，选择想要安装的版本的docker-ce docker-ce-cli contaided.io下载后用如下命令安装。</li>
<li>
<blockquote>
<p>dpkg -i docker-ce*.deb</p>
</blockquote>
</li>
</ul>
<h3 id="docker%E6%8D%A2%E6%BA%90">docker换源</h3>
<p>Docker 使用 /etc/docker/daemon.json（Linux） 或者 %programdata%\docker\config\daemon.json（Windows） 来配置 Daemon。</p>
<pre class="hljs"><code><div>{ 
    &quot;registry-mirrors&quot;: [
        &quot;https://docker.mirrors.ustc.edu.cn&quot;,
        &quot;https://registry.docker-cn.com&quot;,
        &quot;https://cr.console.aliyun.com/&quot;]
}
</div></code></pre>
<p><a href="https://lug.ustc.edu.cn/wiki/mirrors/help/docker/">参考</a></p>
<h2 id="2-docker-compose%E9%83%A8%E7%BD%B2">2. docker-compose部署</h2>
<p><a href="https://cloud.seafile.com/published/seafile-manual-cn/docker/%E7%94%A8Docker%E9%83%A8%E7%BD%B2Seafile.md">官方文档</a></p>
<ol>
<li>
<p>安装docker-compose</p>
<blockquote>
<p>sudo apt-get update</p>
<p>sudo apt-get install docker-compose</p>
</blockquote>
</li>
<li>
<p>配置docker-compose.yml <br>
docker-compose.yml下载路径 <a href="https://docs.seafile.com/d/cb1d3f97106847abbf31/files/?p=/docker/docker-compose.yml">社区版</a> <a href="https://docs.seafile.com/d/cb1d3f97106847abbf31/files/?p=/docker/pro-edition/docker-compose.yml">专业版</a></p>
<p>需要配置的部分文档中都会有# Requested的注释，注意seafile一栏下的端口- &quot;80:80&quot;(前面的80为服务器端口，后面的80为docker内部端口，一般按需要修改前一个80端口，比如这里修改为- &quot;8000:80&quot;)</p>
</li>
<li>
<p>启动docker</p>
<blockquote>
<p>docker-compose up -d # -d是后台运行，如果想要看运行信息，可以不加</p>
</blockquote>
<p><strong>运行问题：</strong> ERROR: Couldn't connect to Docker daemon at http+docker://localunixsocket - is it running?<br>
<strong>解决办法：</strong> 将当前用户加入docker组</p>
<blockquote>
<p>sudo gpasswd -a ${USER} docker <br>
或者<br>
sudo usermod -aG docker $USER</p>
</blockquote>
<p>然后切换到其它用户，再切换回来就正常了。<br>
<strong>参考：</strong><a href="https://blog.csdn.net/xiojing825/article/details/79494408">解决 ERROR: Couldn't connect to Docker daemon at http+docker://localunixsocket - is it running?</a></p>
</li>
<li>
<p>网页端配置<br></p>
<ul>
<li>登录云服务器控制台开放端口，比如我在步骤2中配置的端口为8000；</li>
<li>打开网页 <a href="http://yourip:8000%EF%BC%8C%E8%BE%93%E5%85%A5%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%EF%BC%9B">http://yourip:8000，输入账号密码登录；</a></li>
<li>点击头像-&gt;系统设置-&gt;设置，分别修改<strong>SERVICE_URL</strong>与<strong>FILE_SERVER_ROOT</strong>为<a href="http://yourip:8000">http://yourip:8000</a>和<a href="http://yourip:8000/seafhttp">http://yourip:8000/seafhttp</a>(注意这里一定要填对端口，默认没有端口是因为默认为80端口，在http中可以省略，如果步骤2中修改了端口，这里一定要进行修改，否则客户端无法登录以及正常的上传文件)；</li>
</ul>
</li>
</ol>
<h2 id="3-%E5%85%B6%E5%AE%83%E9%97%AE%E9%A2%98">3. 其它问题</h2>
<h3 id="1-%E6%96%87%E4%BB%B6%E5%8E%86%E5%8F%B2%E9%A1%B5%E9%9D%A2page-unavailable">1. <strong>文件历史页面Page unavailable</strong></h3>
<p><strong>分析</strong>：查看seafile/log/seahub.log，显示AttributeError: 'NoneType' object has no attribute 'get_file_history_suffix'</p>
<p><strong>原因</strong>：从专业版更换到社区版，专业版的配置文件没有删除</p>
<p><strong>解决办法</strong>：删除seafile/conf目录下的seafevents.conf文件，重新启动seafile和seahub</p>
<p><a href="https://forum.seafile.com/t/resolved-failed-to-view-files-history/9743/2">参考:Failed to view file’s history</a></p>
<h1 id="2-seafile%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB">2. seafile数据迁移</h1>
<h2 id="1-%E6%BA%90%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E5%A4%87%E4%BB%BD">1. 源服务器端备份</h2>
<p>我们假设您的 seafile 数据卷路径是 /opt/seafile-data，并且您想将备份数据存放到 /opt/seafile-backup 目录下。</p>
<p>您可以创建一个类似以下 /opt/seafile-backup 的目录结构：</p>
<pre class="hljs"><code><div>/opt/seafile-backup

---- databases/  用来存放 MySQL 容器的备份数据

---- data/  用来存放 Seafile 容器的备份数据
</div></code></pre>
<p>要备份的数据文件：</p>
<pre class="hljs"><code><div># 注意这里的conf目录内的文件是配置文件，需要备份，但是环境不同时，不能在新的服务器上进行恢复，否则会page-unavailable，只是作为参考
/opt/seafile-data/seafile/conf  # configuration files

/opt/seafile-data/seafile/seafile-data # data of seafile

/opt/seafile-data/seafile/seahub-data # data of seahub
</div></code></pre>
<ul>
<li>备份数据库</li>
</ul>
<pre class="hljs"><code><div># 建议每次将数据库备份到一个单独的文件中。至少在一周内不要覆盖旧的数据库备份。

cd /opt/seafile-backup/databases

docker exec -it seafile-mysql mysqldump  -uroot -p[passwd] --opt ccnet_db &gt; ccnet_db.sql

docker exec -it seafile-mysql mysqldump  -uroot -p[passwd] --opt seafile_db &gt; seafile_db.sql

docker exec -it seafile-mysql mysqldump  -uroot -p[passwd] --opt seahub_db &gt; seahub_db.sql

# 注意备份数据库时加上-p[passwd], [passwd]为你的mysql密码，官方教程没有加，实际恢复时无法恢复数据库
</div></code></pre>
<ul>
<li>备份 Seafile 资料库数据</li>
</ul>
<pre class="hljs"><code><div># 方法1 cp 复制
cp -R /opt/seafile-data/seafile /opt/seafile-backup/data/

# 方法2 rsync增量备份
rsync -az --delete /opt/seafile-data/seafile /opt/seafile-backup/data/

# --delete 参数是让目标目录与源目录保持完全一致，如果不加，源目录中删除的文件，目标目录仍会保留，可根据自己情况选择。
# -z 是在传输过程中压缩数据，对于文件类文件能够有效提高效率
</div></code></pre>
<h2 id="2-%E7%9B%AE%E6%A0%87%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%81%A2%E5%A4%8D%E6%95%B0%E6%8D%AE">2. 目标服务器恢复数据</h2>
<ul>
<li>恢复数据库</li>
</ul>
<pre class="hljs"><code><div>docker cp /opt/seafile-backup/databases/ccnet_db.sql seafile-mysql:/tmp/ccnet_db.sql
docker cp /opt/seafile-backup/databases/seafile_db.sql seafile-mysql:/tmp/seafile_db.sql
docker cp /opt/seafile-backup/databases/seahub_db.sql seafile-mysql:/tmp/seahub_db.sql

docker exec -it seafile-mysql /bin/sh -c &quot;mysql -uroot -p[passwd] ccnet_db &lt; /tmp/ccnet_db.sql&quot;
docker exec -it seafile-mysql /bin/sh -c &quot;mysql -uroot -p[passwd] seafile_db &lt; /tmp/seafile_db.sql&quot;
docker exec -it seafile-mysql /bin/sh -c &quot;mysql -uroot -p[passwd] seahub_db &lt; /tmp/seahub_db.sql&quot;

# 同1中也要加上-p[passwd]，否则会没有访问权限
</div></code></pre>
<ul>
<li>恢复数据</li>
</ul>
<pre class="hljs"><code><div>rsync -az --delete /opt/seafile-backup/data/seafile/seafile-data /opt/seafile-data/seafile/
rsync -az --delete /opt/seafile-backup/data/seafile/seahub-data /opt/seafile-data/seafile/
</div></code></pre>
<h2 id="3-%E5%85%B6%E5%AE%83%E9%97%AE%E9%A2%98">3. 其它问题</h2>
<ul>
<li>迁移数据后，新的seafile服务器启动后，无法访问文件</li>
</ul>
<pre class="hljs"><code><div>具体描述: 网页端上传下载文件，显示Bad access token

docker-compose up 查看log显示：
Error: the user running the script (&quot;root&quot;) is not the owner of &quot;/shared/seafile/seafile-data&quot; folder

解决办法：修改 /opt/seafile-data的所有者为root
sudo chown -R root /opt/seafile-data
</div></code></pre>
<p><strong>参考</strong>：<br>
<a href="https://cloud.seafile.com/published/seafile-manual-cn/docker/%E7%94%A8Docker%E9%83%A8%E7%BD%B2Seafile.md">Docker部署seafile</a><br>
<a href="https://bbs.seafile.com/t/topic/10958">迁移本地Seafile到docker</a></p>

</body>
</html>
